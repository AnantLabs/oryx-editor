<html><head><meta http-equiv="content-type" content="text/html; charset=UTF-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="COMM">/** * Copyright (c) 2006 * Martin Czuchra, Nicolas Peters, Daniel Polak, Willi Tscheschner * * Permission is hereby granted, free of charge, to any person obtaining a * copy of this software and associated documentation files (the "Software"), * to deal in the Software without restriction, including without limitation * the rights to use, copy, modify, merge, publish, distribute, sublicense, * and/or sell copies of the Software, and to permit persons to whom the * Software is furnished to do so, subject to the following conditions: * * The above copyright notice and this permission notice shall be included in * all copies or substantial portions of the Software. * * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER * DEALINGS IN THE SOFTWARE. **/</span><span class="WHIT"></span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">ORYX.Plugins</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">ORYX.Plugins</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Object</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="NAME">ORYX.Plugins.DragDocker</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Clazz.extend</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 *	Constructor	 *	@param {Object} Facade: The Facade of the Editor	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">construct</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">facade</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">facade</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Set the valid and invalid color</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.VALIDCOLOR</span><span class="WHIT"> 	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SELECTION_VALID_COLOR</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.INVALIDCOLOR</span><span class="WHIT"> 	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SELECTION_INVALID_COLOR</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Define Variables </span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.shapeSelection</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.docker</span><span class="WHIT"> 		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.dockerParent</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.dockerSource</span><span class="WHIT"> 	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.dockerTarget</span><span class="WHIT"> 	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.lastUIObj</span><span class="WHIT"> 		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.isStartDocker</span><span class="WHIT"> 	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.isEndDocker</span><span class="WHIT"> 	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.undockTreshold</span><span class="WHIT">	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.initialDockerPosition</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.outerDockerNotMoved</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.isValid</span><span class="WHIT"> 		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// For the Drag and Drop</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Register on MouseDown-Event on a Docker</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.registerOnEvent</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_MOUSEDOWN</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.handleMouseDown.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.registerOnEvent</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_DOCKERDRAG</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.handleDockerDrag.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Register on over/out to show / hide a docker</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.registerOnEvent</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_MOUSEOVER</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.handleMouseOver.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.registerOnEvent</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_MOUSEOUT</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.handleMouseOut.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * MouseOut Handler	 *	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">handleMouseOut</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// If there is a Docker, hide this</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.docker</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Controls.Docker</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">uiObj.hide</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.docker</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Edge</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">uiObj.dockers.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">docker</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">docker.hide</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * MouseOver Handler	 *	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">handleMouseOver</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// If there is a Docker, show this		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.docker</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Controls.Docker</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">uiObj.show</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.docker</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Edge</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">uiObj.dockers.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">docker</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">docker.show</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * DockerDrag Handler	 * delegates the uiEvent of the drag event to the mouseDown function	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">handleDockerDrag</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.handleMouseDown</span><span class="PUNC">(</span><span class="NAME">event.uiEvent</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * MouseDown Handler	 *	 */</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">handleMouseDown</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// If there is a Docker</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Controls.Docker</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">uiObj.isMovable</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">/* Buffering shape selection and clear selection*/</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.shapeSelection</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.facade.setSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.docker</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.initialDockerPosition</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.docker.bounds.center</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.outerDockerNotMoved</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.dockerParent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">uiObj.parent</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// Define command arguments</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this._commandArg</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">docker</span><span class="PUNC">:</span><span class="NAME">uiObj</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dockedShape</span><span class="PUNC">:</span><span class="NAME">uiObj.getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">refPoint</span><span class="PUNC">:</span><span class="NAME">uiObj.referencePoint</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">uiObj.bounds.center</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// Show the Docker</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.docker.show</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// If the Dockers Parent is an Edge, </span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">//  and the Docker is either the first or last Docker of the Edge</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">uiObj.parent</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Edge</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">			   	</span><span class="PUNC">(</span><span class="NAME">uiObj.parent.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">uiObj.parent.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Get the Edge Source or Target</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">uiObj.parent.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">uiObj.parent.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.dockerTarget</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">uiObj.parent.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">uiObj.parent.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">uiObj.parent.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.dockerSource</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">uiObj.parent.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// If there parent is not an Edge, undefined the Source and Target</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.dockerSource</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.dockerTarget</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.isStartDocker</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.docker.parent.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">this.docker</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.isEndDocker</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.docker.parent.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">this.docker</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// add to canvas while dragging</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">add</span><span class="PUNC">(</span><span class="NAME">this.docker.parent</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// Hide all Labels from Docker</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.docker.parent.getLabels</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">label</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">label.hide</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// Undocked the Docker from current Shape</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.isStartDocker</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">this.isEndDocker</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">this.docker.isDocked</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.docker.setDockedShape</span><span class="PUNC">(</span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Set the Docker to the center of the mouse pointer</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">evPos</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.eventCoordinates</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.docker.bounds.centerMoveTo</span><span class="PUNC">(</span><span class="NAME">evPos</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">//this.docker.update()</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">//this.facade.getCanvas().update();</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.dockerParent._update</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.outerDockerNotMoved</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">option</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">movedCallback</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.dockerMoved.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">upCallback</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.dockerMovedFinished.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// Enable the Docker for Drag'n'Drop, give the mouseMove and mouseUp-Callback with</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">ORYX.Core.UIEnableDrag</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">option</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * Docker MouseMove Handler	 *	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">dockerMoved</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.outerDockerNotMoved</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">snapToMagnet</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.docker.parent</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.isStartDocker</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.isEndDocker</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Get the EventPosition and all Shapes on these point</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">evPos</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.eventCoordinates</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.docker.isDocked</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">/* Only consider start/end dockers if they are moved over a treshold */</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">distanceDockerPointer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">ORYX.Core.Math.getDistancePointToPoint</span><span class="PUNC">(</span><span class="NAME">evPos</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.initialDockerPosition</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">distanceDockerPointer</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">this.undockTreshold</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">this.outerDockerNotMoved</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">/* Undock the docker */</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.docker.setDockedShape</span><span class="PUNC">(</span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">// Set the Docker to the center of the mouse pointer</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">//this.docker.bounds.centerMoveTo(evPos);</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.dockerParent._update</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">shapes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getAbstractShapesAtPosition</span><span class="PUNC">(</span><span class="NAME">evPos</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Get the top level Shape on these, but not the same as Dockers parent</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shapes.pop</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.docker.parent</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shapes.pop</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// If the top level Shape the same as the last Shape, then return</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.lastUIObj</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">//return;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// If the top level uiObj instance of Shape and this isn't the parent of the docker </span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Shape</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">						</span><span class="COMM">// Get the StencilSet of the Edge</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.docker.parent.getStencil</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">stencilSet</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="WHIT"></span><span class="WHIT">						</span><span class="COMM">// Ask by the StencilSet if the source, the edge and the target valid connections.</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.docker.parent</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Edge</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="WHIT"></span><span class="WHIT">							</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">highestParent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getHighestParentBeforeCanvas</span><span class="PUNC">(</span><span class="NAME">uiObj</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="COMM">/* Ensure that the shape to dock is not a child shape 							 * of the same edge.							 */</span><span class="WHIT"></span><span class="WHIT">							</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">highestParent</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Edge</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">									</span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.docker.parent</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">highestParent</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">								</span><span class="NAME">this.isValid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">								</span><span class="NAME">this.dockerParent._update</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">								</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">this.isValid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">curObj</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">orgObj</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="KEYW">while</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.isValid</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">curObj</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">curObj</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Canvas</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">								</span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">curObj</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">								</span><span class="NAME">this.isValid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">canConnect</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">											</span><span class="NAME">sourceShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.dockerSource</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="COMM">// Is there a docked source </span><span class="WHIT"></span><span class="WHIT">															</span><span class="NAME">this.dockerSource</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="COMM">// than set this</span><span class="WHIT"></span><span class="WHIT">															</span><span class="PUNC">(</span><span class="NAME">this.isStartDocker</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="COMM">// if not and if the Docker is the start docker</span><span class="WHIT"></span><span class="WHIT">																</span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="COMM">// take the last uiObj</span><span class="WHIT"></span><span class="WHIT">																</span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="COMM">// if not set it to undefined;</span><span class="WHIT"></span><span class="WHIT">											</span><span class="NAME">edgeShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.docker.parent</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">											</span><span class="NAME">targetShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.dockerTarget</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="COMM">// Is there a docked target </span><span class="WHIT"></span><span class="WHIT">											</span><span class="NAME">this.dockerTarget</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="COMM">// than set this</span><span class="WHIT"></span><span class="WHIT">														</span><span class="PUNC">(</span><span class="NAME">this.isEndDocker</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="COMM">// if not and if the Docker is not the start docker</span><span class="WHIT"></span><span class="WHIT">															</span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="COMM">// take the last uiObj</span><span class="WHIT"></span><span class="WHIT">															</span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="COMM">// if not set it to undefined;</span><span class="WHIT"></span><span class="WHIT">										</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">								</span><span class="NAME">curObj</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">curObj.parent</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">							</span><span class="WHIT"></span><span class="WHIT">							</span><span class="COMM">// Reset uiObj if no </span><span class="WHIT"></span><span class="WHIT">							</span><span class="COMM">// valid parent is found</span><span class="WHIT"></span><span class="WHIT">							</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.isValid</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">								</span><span class="NAME">uiObj</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">orgObj</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">this.isValid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">canConnect</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">								</span><span class="NAME">sourceShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">								</span><span class="NAME">edgeShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.docker.parent</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">								</span><span class="NAME">targetShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.docker.parent</span><span class="WHIT"></span><span class="WHIT">							</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">						</span><span class="WHIT"></span><span class="WHIT">						</span><span class="COMM">// If there is a lastUIObj, hide the magnets</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.lastUIObj</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">this.hideMagnets</span><span class="PUNC">(</span><span class="NAME">this.lastUIObj</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">						</span><span class="WHIT"></span><span class="WHIT">						</span><span class="COMM">// If there is a valid connection, show the magnets</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.isValid</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">this.showMagnets</span><span class="PUNC">(</span><span class="NAME">uiObj</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">						</span><span class="WHIT"></span><span class="WHIT">						</span><span class="COMM">// Set the Highlight Rectangle by these value</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">this.showHighlight</span><span class="PUNC">(</span><span class="NAME">uiObj</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.isValid</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">this.VALIDCOLOR</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.INVALIDCOLOR</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="WHIT"></span><span class="WHIT">						</span><span class="COMM">// Buffer the current Shape</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">this.lastUIObj</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">uiObj</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="COMM">// If there is no top level Shape, then hide the highligting of the last Shape</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">this.hideHighlight</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">this.lastUIObj</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">this.hideMagnets</span><span class="PUNC">(</span><span class="NAME">this.lastUIObj</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">this.lastUIObj</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">this.isValid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Snap to the nearest Magnet</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.lastUIObj</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.isValid</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">event.shiftKey</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">event.ctrlKey</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">snapToMagnet</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.lastUIObj.magnets.find</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">magnet</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">magnet.absoluteBounds</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">isIncluded</span><span class="PUNC">(</span><span class="NAME">evPos</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">snapToMagnet</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">this.docker.bounds.centerMoveTo</span><span class="PUNC">(</span><span class="NAME">snapToMagnet.absoluteCenterXY</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">//this.docker.update()</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Snap to on the nearest Docker of the same parent</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">event.shiftKey</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">event.ctrlKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">snapToMagnet</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">minOffset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.DOCKER_SNAP_OFFSET</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nearestX</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">minOffset</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nearestY</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">minOffset</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">dockerCenter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.docker.bounds.center</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.docker.parent</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.docker.parent.dockers.each</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">docker</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.docker</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">docker</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">return</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">center</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">docker.referencePoint</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">docker.getAbsoluteReferencePoint</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.bounds.center</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">nearestX</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">nearestX</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">center.x</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">dockerCenter.x</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">center.x</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">dockerCenter.x</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">nearestX</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">nearestY</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">nearestY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">center.y</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">dockerCenter.y</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">center.y</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">dockerCenter.y</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">nearestY</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">nearestX</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">minOffset</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">nearestY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">minOffset</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">nearestX</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">nearestX</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">minOffset</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">nearestX</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">nearestY</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">nearestY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">minOffset</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">nearestY</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.docker.bounds.centerMoveTo</span><span class="PUNC">(</span><span class="NAME">dockerCenter.x</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">nearestX</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dockerCenter.y</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">nearestY</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">//this.docker.update()</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">previous</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.docker.parent.dockers</span><span class="PUNC">[</span><span class="NAME">Math.max</span><span class="PUNC">(</span><span class="NAME">this.docker.parent.dockers.indexOf</span><span class="PUNC">(</span><span class="NAME">this.docker</span><span class="PUNC">)</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">next</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.docker.parent.dockers</span><span class="PUNC">[</span><span class="NAME">Math.min</span><span class="PUNC">(</span><span class="NAME">this.docker.parent.dockers.indexOf</span><span class="PUNC">(</span><span class="NAME">this.docker</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.docker.parent.dockers.length</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">previous</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">next</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">previous</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">this.docker</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">next</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">this.docker</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cp</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">previous.bounds.center</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cn</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">next.bounds.center</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cd</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.docker.bounds.center</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="WHIT"></span><span class="WHIT">						</span><span class="COMM">// Checks if the point is on the line between previous and next</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ORYX.Core.Math.isPointInLine</span><span class="PUNC">(</span><span class="NAME">cd.x</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">cd.y</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">cp.x</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">cp.y</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">cn.x</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">cn.y</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="COMM">// Get the rise</span><span class="WHIT"></span><span class="WHIT">							</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">raise</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">Number</span><span class="PUNC">(</span><span class="NAME">cn.y</span><span class="PUNC">)</span><span class="PUNC">-</span><span class="NAME">Number</span><span class="PUNC">(</span><span class="NAME">cp.y</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="PUNC">(</span><span class="NAME">Number</span><span class="PUNC">(</span><span class="NAME">cn.x</span><span class="PUNC">)</span><span class="PUNC">-</span><span class="NAME">Number</span><span class="PUNC">(</span><span class="NAME">cp.x</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="COMM">// Calculate the intersection point</span><span class="WHIT"></span><span class="WHIT">							</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">intersecX</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">cp.y</span><span class="PUNC">-</span><span class="PUNC">(</span><span class="NAME">cp.x</span><span class="PUNC">*</span><span class="NAME">raise</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">-</span><span class="PUNC">(</span><span class="NAME">cd.y</span><span class="PUNC">-</span><span class="PUNC">(</span><span class="NAME">cd.x</span><span class="PUNC">*</span><span class="PUNC">(</span><span class="PUNC">-</span><span class="NAME">Math.pow</span><span class="PUNC">(</span><span class="NAME">raise</span><span class="PUNC">,</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="PUNC">-</span><span class="NAME">Math.pow</span><span class="PUNC">(</span><span class="NAME">raise</span><span class="PUNC">,</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">-</span><span class="NAME">raise</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">intersecY</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">cp.y</span><span class="PUNC">-</span><span class="PUNC">(</span><span class="NAME">cp.x</span><span class="PUNC">*</span><span class="NAME">raise</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="PUNC">(</span><span class="NAME">raise</span><span class="PUNC">*</span><span class="NAME">intersecX</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="WHIT"></span><span class="WHIT">							</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">isNaN</span><span class="PUNC">(</span><span class="NAME">intersecX</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">isNaN</span><span class="PUNC">(</span><span class="NAME">intersecY</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">							</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">this.docker.bounds.centerMoveTo</span><span class="PUNC">(</span><span class="NAME">intersecX</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">intersecY</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">//this.facade.getCanvas().update();</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.dockerParent._update</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * Docker MouseUp Handler	 *	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">dockerMovedFinished</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">/* Reset to buffered shape selection */</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.setSelection</span><span class="PUNC">(</span><span class="NAME">this.shapeSelection</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Hide the border</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.hideHighlight</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Show all Labels from Docker</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.dockerParent.getLabels</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">label</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">label.show</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">//label.update();</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// If there is a last top level Shape</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.lastUIObj</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.isStartDocker</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.isEndDocker</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// If there is a valid connection, the set as a docked Shape to them</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.isValid</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.docker.setDockedShape</span><span class="PUNC">(</span><span class="NAME">this.lastUIObj</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.facade.raiseEvent</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">type</span><span class="WHIT"> 	</span><span class="PUNC">:</span><span class="NAME">ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">docker</span><span class="WHIT">	</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.docker</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">parent</span><span class="WHIT">	</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.docker.parent</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">target</span><span class="WHIT">	</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.lastUIObj</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.hideMagnets</span><span class="PUNC">(</span><span class="NAME">this.lastUIObj</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Hide the Docker</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.docker.hide</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.outerDockerNotMoved</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// Get the EventPosition and all Shapes on these point</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">evPos</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.eventCoordinates</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">shapes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getAbstractShapesAtPosition</span><span class="PUNC">(</span><span class="NAME">evPos</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">/* Remove edges from selection */</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">shapeWithoutEdges</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shapes.findAll</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">node</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Node</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">shapes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shapeWithoutEdges.length</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">shapeWithoutEdges</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">shapes</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.facade.setSelection</span><span class="PUNC">(</span><span class="NAME">shapes</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">//Command-Pattern for dragging one docker</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">dragDockerCommand</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Command.extend</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">construct</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">docker</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newPos</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">oldPos</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newDockedShape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">oldDockedShape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">facade</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.docker</span><span class="WHIT"> 		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">docker</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.index</span><span class="WHIT">			</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">docker.parent.dockers.indexOf</span><span class="PUNC">(</span><span class="NAME">docker</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.newPosition</span><span class="WHIT">	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newPos</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.newDockedShape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newDockedShape</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.oldPosition</span><span class="WHIT">	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">oldPos</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.oldDockedShape</span><span class="WHIT">	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">oldDockedShape</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.facade</span><span class="WHIT">			</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">facade</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.index</span><span class="WHIT">			</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">docker.parent.dockers.indexOf</span><span class="PUNC">(</span><span class="NAME">docker</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.shape</span><span class="WHIT">			</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">docker.parent</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">execute</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.docker.parent</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">this.docker</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.shape.dockers</span><span class="PUNC">[</span><span class="NAME">this.index</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.dock</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">this.newDockedShape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.newPosition</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.removedDockers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.shape.removeUnusedDockers</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.facade.updateSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">rollback</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.dock</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">this.oldDockedShape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.oldPosition</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">(</span><span class="NAME">this.removedDockers</span><span class="PUNC">||</span><span class="NAME">$H</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">d</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">this.shape.add</span><span class="PUNC">(</span><span class="NAME">d.value</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">Number</span><span class="PUNC">(</span><span class="NAME">d.key</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">this.shape._update</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.facade.updateSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">dock</span><span class="PUNC">:</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">toDockShape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pos</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">// Set the Docker to the new Shape</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.docker.setDockedShape</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">toDockShape</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">this.docker.setDockedShape</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">toDockShape</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">this.docker.setReferencePoint</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">pos</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="COMM">//this.docker.update();	</span><span class="WHIT"></span><span class="WHIT">						</span><span class="COMM">//this.docker.parent._update();				</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">this.docker.bounds.centerMoveTo</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">pos</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">update</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">												</span><span class="WHIT"></span><span class="WHIT">								</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.docker.parent</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Instanziate the dockCommand</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">command</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">dragDockerCommand</span><span class="PUNC">(</span><span class="NAME">this.docker</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.docker.getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">this.docker.referencePoint</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.docker.bounds.center</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this._commandArg.refPoint</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.docker.getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this._commandArg.dockedShape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.facade</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.facade.executeCommands</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">command</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Update all Shapes</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">//this.facade.updateSelection();</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Undefined all variables</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.docker</span><span class="WHIT"> 		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.dockerParent</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.dockerSource</span><span class="WHIT"> 	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.dockerTarget</span><span class="WHIT"> 	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.lastUIObj</span><span class="WHIT"> 		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * Hide the highlighting	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">hideHighlight</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.raiseEvent</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">type</span><span class="PUNC">:</span><span class="NAME">ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">highlightId</span><span class="PUNC">:</span><span class="STRN">'validDockedShape'</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * Show the highlighting	 *	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">showHighlight</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">uiObj</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">color</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.raiseEvent</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">										</span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT">		</span><span class="NAME">ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">										</span><span class="NAME">highlightId</span><span class="PUNC">:</span><span class="STRN">'validDockedShape'</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">										</span><span class="NAME">elements</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="PUNC">[</span><span class="NAME">uiObj</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">										</span><span class="NAME">color</span><span class="PUNC">:</span><span class="WHIT">		</span><span class="NAME">color</span><span class="WHIT"></span><span class="WHIT">									</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">showMagnets</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">uiObj</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">uiObj.magnets.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">magnet</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">magnet.show</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">hideMagnets</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">uiObj</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">uiObj.magnets.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">magnet</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">magnet.hide</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">getHighestParentBeforeCanvas</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Shape</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.parent</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">while</span><span class="PUNC">(</span><span class="NAME">parent</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">parent.parent</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Canvas</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">parent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parent.parent</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">parent</span><span class="PUNC">;</span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">	</span><span class="WHIT"></span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span></pre></body></html>