<html><head><meta http-equiv="content-type" content="text/html; charset=UTF-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="WHIT"></span><span class="COMM">/** * Copyright (c) 2006 * Martin Czuchra, Nicolas Peters, Daniel Polak, Willi Tscheschner * * Permission is hereby granted, free of charge, to any person obtaining a * copy of this software and associated documentation files (the "Software"), * to deal in the Software without restriction, including without limitation * the rights to use, copy, modify, merge, publish, distribute, sublicense, * and/or sell copies of the Software, and to permit persons to whom the * Software is furnished to do so, subject to the following conditions: * * The above copyright notice and this permission notice shall be included in * all copies or substantial portions of the Software. * * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER * DEALINGS IN THE SOFTWARE. **/</span><span class="WHIT"></span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">ORYX.Plugins</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">ORYX.Plugins</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Object</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="NAME">ORYX.Plugins.Edit</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Clazz.extend</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">construct</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">facade</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.facade</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">facade</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.clipboard</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">ORYX.Plugins.Edit.ClipBoard</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">//this.facade.registerOnEvent(ORYX.CONFIG.EVENT_KEYDOWN, this.keyHandler.bind(this));</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.facade.offer</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">name</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.Edit.cut</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">description</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.Edit.cutDesc</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">icon</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.PATH</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"images/cut.png"</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">		 </span><span class="NAME">keyCodes</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">metaKeys</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">ORYX.CONFIG.META_KEY_META_CTRL</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">keyCode</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">88</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">keyAction</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.KEY_ACTION_DOWN</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		 </span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">functionality</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.callEdit.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.editCut</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">group</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.Edit.group</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">index</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">minShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"></span><span class="WHIT">         </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">         </span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.facade.offer</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">name</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.Edit.copy</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">description</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.Edit.copyDesc</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">icon</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.PATH</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"images/page_copy.png"</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">		 </span><span class="NAME">keyCodes</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">metaKeys</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">ORYX.CONFIG.META_KEY_META_CTRL</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">keyCode</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">67</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">keyAction</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.KEY_ACTION_DOWN</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		 </span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">functionality</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.callEdit.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.editCopy</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">group</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.Edit.group</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">index</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">minShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"></span><span class="WHIT">         </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">         </span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.facade.offer</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">name</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.Edit.paste</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">description</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.Edit.pasteDesc</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">icon</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.PATH</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"images/page_paste.png"</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">		 </span><span class="NAME">keyCodes</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">metaKeys</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">ORYX.CONFIG.META_KEY_META_CTRL</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">keyCode</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">86</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">keyAction</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.KEY_ACTION_DOWN</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		 </span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">functionality</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.callEdit.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.editPaste</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">isEnabled</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.clipboard.isOccupied.bind</span><span class="PUNC">(</span><span class="NAME">this.clipboard</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">group</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.Edit.group</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">index</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">minShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">         </span><span class="NAME">maxShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"></span><span class="WHIT">         </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">         </span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.facade.offer</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">name</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.Edit.del</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">description</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.Edit.delDesc</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">icon</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.PATH</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"images/cross.png"</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">keyCodes</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">metaKeys</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">ORYX.CONFIG.META_KEY_META_CTRL</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">keyCode</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">8</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">keyAction</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.KEY_ACTION_DOWN</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">keyCode</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">46</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">keyAction</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.KEY_ACTION_DOWN</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">functionality</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.callEdit.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.editDelete</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">group</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.Edit.group</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">index</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">minShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">callEdit</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">fn</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">args</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">window.setTimeout</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">fn.apply</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">args</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">args</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * Handles the mouse down event and starts the copy-move-paste action, if	 * control or meta key is pressed.	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">handleMouseDown</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this._controlPressed</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this._controlPressed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.editCopy</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="COMM">//			console.log("copiedEle: %0",this.clipboard.shapesAsJson)</span><span class="WHIT"></span><span class="COMM">//			console.log("mousevent: %o",event)</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.editPaste</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">event.forceExecution</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.facade.raiseEvent</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.clipboard.shapesAsJson</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">    </span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * The key handler for this plugin. Every action from the set of cut, copy,     * paste and delete should be accessible trough simple keyboard shortcuts.     * This method checks whether any event triggers one of those actions.     *     * @param {Object} event The keyboard event that should be analysed for     *     triggering of this plugin.     */</span><span class="WHIT"></span><span class="COMM">//    keyHandler: function(event){</span><span class="WHIT"></span><span class="COMM">//        //TODO document what event.which is.</span><span class="WHIT"></span><span class="COMM">//        </span><span class="WHIT"></span><span class="COMM">//        ORYX.Log.debug("edit.js handles a keyEvent.");</span><span class="WHIT"></span><span class="COMM">//        </span><span class="WHIT"></span><span class="COMM">//        // assure we have the current event.</span><span class="WHIT"></span><span class="COMM">//        if (!event) </span><span class="WHIT"></span><span class="COMM">//            event = window.event;</span><span class="WHIT"></span><span class="COMM">//        </span><span class="WHIT"></span><span class="COMM">//        </span><span class="WHIT"></span><span class="COMM">//        // get the currently pressed key and state of control key.</span><span class="WHIT"></span><span class="COMM">//        var pressedKey = event.which || event.keyCode;</span><span class="WHIT"></span><span class="COMM">//        var ctrlPressed = event.ctrlKey;</span><span class="WHIT"></span><span class="COMM">//        </span><span class="WHIT"></span><span class="COMM">//        // if the object is to be deleted, do so, and return immediately.</span><span class="WHIT"></span><span class="COMM">//        if ((pressedKey == ORYX.CONFIG.KEY_CODE_DELETE) ||</span><span class="WHIT"></span><span class="COMM">//        ((pressedKey == ORYX.CONFIG.KEY_CODE_BACKSPACE) &&</span><span class="WHIT"></span><span class="COMM">//        (event.metaKey || event.appleMetaKey))) {</span><span class="WHIT"></span><span class="COMM">//        </span><span class="WHIT"></span><span class="COMM">//            ORYX.Log.debug("edit.js deletes the shape.");</span><span class="WHIT"></span><span class="COMM">//            this.editDelete();</span><span class="WHIT"></span><span class="COMM">//            return;</span><span class="WHIT"></span><span class="COMM">//        }</span><span class="WHIT"></span><span class="COMM">//        </span><span class="WHIT"></span><span class="COMM">//         // if control key is not pressed, we're not interested anymore.</span><span class="WHIT"></span><span class="COMM">//         if (!ctrlPressed)</span><span class="WHIT"></span><span class="COMM">//         return;</span><span class="WHIT"></span><span class="COMM">//         </span><span class="WHIT"></span><span class="COMM">//         // when ctrl is pressed, switch trough the possibilities.</span><span class="WHIT"></span><span class="COMM">//         switch (pressedKey) {</span><span class="WHIT"></span><span class="COMM">//         </span><span class="WHIT"></span><span class="COMM">//	         // cut.</span><span class="WHIT"></span><span class="COMM">//	         case ORYX.CONFIG.KEY_CODE_X:</span><span class="WHIT"></span><span class="COMM">//	         this.editCut();</span><span class="WHIT"></span><span class="COMM">//	         break;</span><span class="WHIT"></span><span class="COMM">//	         </span><span class="WHIT"></span><span class="COMM">//	         // copy.</span><span class="WHIT"></span><span class="COMM">//	         case ORYX.CONFIG.KEY_CODE_C:</span><span class="WHIT"></span><span class="COMM">//	         this.editCopy();</span><span class="WHIT"></span><span class="COMM">//	         break;</span><span class="WHIT"></span><span class="COMM">//	         </span><span class="WHIT"></span><span class="COMM">//	         // paste.</span><span class="WHIT"></span><span class="COMM">//	         case ORYX.CONFIG.KEY_CODE_V:</span><span class="WHIT"></span><span class="COMM">//	         this.editPaste();</span><span class="WHIT"></span><span class="COMM">//	         break;</span><span class="WHIT"></span><span class="COMM">//         }</span><span class="WHIT"></span><span class="COMM">//    },</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * Returns a list of shapes which should be considered while copying.     * Besides the shapes of given ones, edges and attached nodes are added to the result set.     * If one of the given shape is a child of another given shape, it is not put into the result.      */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">getAllShapesToConsider</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shapes</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">shapesToConsider</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// only top-level shapes</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">childShapesToConsider</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// all child shapes of top-level shapes</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">shapes.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">//Throw away these shapes which have a parent in given shapes</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">isChildShapeOfAnother</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shapes.any</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">s2</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">s2.hasChildShape</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">isChildShapeOfAnother</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">// This shape should be considered</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">shapesToConsider.push</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">// Consider attached nodes (e.g. intermediate events)</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">shape</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Node</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">attached</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.getOutgoingNodes</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">attached</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">attached.findAll</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">a</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">shapes.include</span><span class="PUNC">(</span><span class="NAME">a</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">shapesToConsider</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shapesToConsider.concat</span><span class="PUNC">(</span><span class="NAME">attached</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            </span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">childShapesToConsider</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">childShapesToConsider.concat</span><span class="PUNC">(</span><span class="NAME">shape.getChildShapes</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">// All edges between considered child shapes should be considered</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">// Look for these edges having incoming and outgoing in childShapesToConsider</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">edgesToConsider</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getChildEdges</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">select</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">edge</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">// Ignore if already added</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">shapesToConsider.include</span><span class="PUNC">(</span><span class="NAME">edge</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">// Ignore if there are no docked shapes</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">edge.getAllDockedShapes</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">size</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">// True if all docked shapes are in considered child shapes</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">edge.getAllDockedShapes</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">all</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="COMM">// Remember: Edges can have other edges on outgoing, that is why edges must not be included in childShapesToConsider</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">shape</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Edge</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">childShapesToConsider.include</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">shapesToConsider</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shapesToConsider.concat</span><span class="PUNC">(</span><span class="NAME">edgesToConsider</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">shapesToConsider</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">    </span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * Performs the cut operation by first copy-ing and then deleting the     * current selection.     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">editCut</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">//TODO document why this returns false.</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">//TODO document what the magic boolean parameters are supposed to do.</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.editCopy</span><span class="PUNC">(</span><span class="KEYW">false</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.editDelete</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">    </span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * Performs the copy operation.     * @param {Object} will_not_update ??     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">editCopy</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">will_update</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">useNoOffset</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">selection</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">//if the selection is empty, do not remove the previously copied elements</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">selection.length</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.clipboard.refresh</span><span class="PUNC">(</span><span class="NAME">selection</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.getAllShapesToConsider</span><span class="PUNC">(</span><span class="NAME">selection</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getStencil</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">stencilSet</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">namespace</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">useNoOffset</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">will_update</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">this.facade.updateSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">    </span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * Performs the paste operation.     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">editPaste</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">// Create a new canvas with childShapes </span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">//and stencilset namespace to be JSON Import conform</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">canvas</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">childShapes</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.clipboard.shapesAsJson</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">stencilset</span><span class="PUNC">:</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">namespace</span><span class="PUNC">:</span><span class="NAME">this.clipboard.SSnamespace</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">// Apply json helper to iterate over json object</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">Ext.apply</span><span class="PUNC">(</span><span class="NAME">canvas</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.AbstractShape.JSONHelper</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">childShapeResourceIds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">  </span><span class="NAME">canvas.getChildShapes</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">pluck</span><span class="PUNC">(</span><span class="STRN">"resourceId"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">outgoings</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">// Iterate over all shapes</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">canvas.eachChild</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">parent</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">// Throw away these references where referenced shape isn't copied</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">shape.outgoing</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.outgoing.select</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">out</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">childShapeResourceIds.include</span><span class="PUNC">(</span><span class="NAME">out.resourceId</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">shape.outgoing.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">out</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">outgoings</span><span class="PUNC">[</span><span class="NAME">out.resourceId</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">outgoings</span><span class="PUNC">[</span><span class="NAME">out.resourceId</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">outgoings</span><span class="PUNC">[</span><span class="NAME">out.resourceId</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">push</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">shape</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">// Iterate over all shapes</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">canvas.eachChild</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">parent</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="WHIT"></span><span class="WHIT">        	</span><span class="COMM">// Check if there has a valid target</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">shape.target</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">childShapeResourceIds.include</span><span class="PUNC">(</span><span class="NAME">shape.target.resourceId</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">shape.target</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">shape.targetRemoved</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    		</span><span class="WHIT"></span><span class="WHIT">    		</span><span class="COMM">// Check if the first docker is removed</span><span class="WHIT"></span><span class="WHIT">    		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT">	</span><span class="NAME">shape.dockers</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">    			</span><span class="NAME">shape.dockers.length</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">    			</span><span class="NAME">shape.dockers</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getDocker</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"></span><span class="WHIT">    			</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">shape.dockers</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getDocker</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"></span><span class="WHIT">    			</span><span class="PUNC">!</span><span class="NAME">childShapeResourceIds.include</span><span class="PUNC">(</span><span class="NAME">shape.dockers</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getDocker</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">resourceId</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">    			</span><span class="PUNC">!</span><span class="NAME">shape.getShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">dockers</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">&&</span><span class="PUNC">!</span><span class="NAME">outgoings</span><span class="PUNC">[</span><span class="NAME">shape.resourceId</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    				</span><span class="WHIT"></span><span class="WHIT">    			</span><span class="NAME">shape.sourceRemoved</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">shape</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">// Iterate over top-level shapes</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">canvas.eachChild</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">parent</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">// All top-level shapes should get an offset in their bounds</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">// Move the shape occording to COPY_MOVE_OFFSET</span><span class="WHIT"></span><span class="WHIT">        	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.clipboard.useOffset</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	            </span><span class="NAME">shape.bounds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	                </span><span class="NAME">lowerRight</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	                    </span><span class="NAME">x</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">shape.bounds.lowerRight.x</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.COPY_MOVE_OFFSET</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	                    </span><span class="NAME">y</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">shape.bounds.lowerRight.y</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.COPY_MOVE_OFFSET</span><span class="WHIT"></span><span class="WHIT">	                </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	                </span><span class="NAME">upperLeft</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	                    </span><span class="NAME">x</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">shape.bounds.upperLeft.x</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.COPY_MOVE_OFFSET</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	                    </span><span class="NAME">y</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">shape.bounds.upperLeft.y</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.COPY_MOVE_OFFSET</span><span class="WHIT"></span><span class="WHIT">	                </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">	            </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        	</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">// Only apply offset to shapes with a target</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">shape.dockers</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">shape.dockers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.dockers.map</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">docker</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="COMM">// If shape had a target but the copied does not have anyone anymore,</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="COMM">// migrate the relative dockers to absolute ones.</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">shape.targetRemoved</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">shape.dockers.length</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">&&</span><span class="NAME">docker.getDocker</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">(</span><span class="NAME">shape.sourceRemoved</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">&&</span><span class="NAME">docker.getDocker</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="NAME">docker</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">docker.getDocker</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bounds.center</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">// If it is the first docker and it has a docked shape, </span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">// just return the coordinates</span><span class="WHIT"></span><span class="WHIT">				   	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">docker.getDocker</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">Function</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">				   		</span><span class="NAME">shape.sourceRemoved</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">docker.getDocker</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">outgoings</span><span class="PUNC">[</span><span class="NAME">shape.resourceId</span><span class="PUNC">]</span><span class="PUNC">||</span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">shape.getShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Node</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">outgoings</span><span class="PUNC">[</span><span class="NAME">shape.resourceId</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Node</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">shape.dockers.length</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">docker.getDocker</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">Function</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">shape.targetRemoved</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">docker.getDocker</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">shape.target</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                        	</span><span class="NAME">x</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.x</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">                        	</span><span class="NAME">y</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.y</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                        	</span><span class="NAME">getDocker</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.getDocker</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.clipboard.useOffset</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	                    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		                        </span><span class="NAME">x</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.x</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.COPY_MOVE_OFFSET</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">		                        </span><span class="NAME">y</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.y</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.COPY_MOVE_OFFSET</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	                        	</span><span class="NAME">getDocker</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.getDocker</span><span class="WHIT"></span><span class="WHIT">		                    </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				   	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				   		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                        	</span><span class="NAME">x</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.x</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">                        	</span><span class="NAME">y</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.y</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                        	</span><span class="NAME">getDocker</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.getDocker</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				   	</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">shape.getShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Node</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">shape.dockers</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">shape.dockers.length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">shape.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDocker</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">shape.sourceRemoved</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">shape.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDocker</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">outgoings</span><span class="PUNC">[</span><span class="NAME">shape.resourceId</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            	</span><span class="WHIT"></span><span class="WHIT">            	</span><span class="NAME">shape.dockers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.dockers.map</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">docker</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            		</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">shape.sourceRemoved</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">&&</span><span class="NAME">docker.getDocker</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    	</span><span class="NAME">docker</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">docker.getDocker</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bounds.center</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.clipboard.useOffset</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	            		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	                        </span><span class="NAME">x</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.x</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.COPY_MOVE_OFFSET</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">	                        </span><span class="NAME">y</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.y</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.COPY_MOVE_OFFSET</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	                    	</span><span class="NAME">getDocker</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.getDocker</span><span class="WHIT"></span><span class="WHIT">	                    </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	            		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	                        </span><span class="NAME">x</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.x</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">	                        </span><span class="NAME">y</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.y</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	                    	</span><span class="NAME">getDocker</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.getDocker</span><span class="WHIT"></span><span class="WHIT">	                    </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            	</span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            </span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">shape</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.clipboard.useOffset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.facade.importJSON</span><span class="PUNC">(</span><span class="NAME">canvas</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">    </span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**     * Performs the delete operation. No more asking.     */</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">editDelete</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">selection</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">clipboard</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">ORYX.Plugins.Edit.ClipBoard</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">clipboard.refresh</span><span class="PUNC">(</span><span class="NAME">selection</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.getAllShapesToConsider</span><span class="PUNC">(</span><span class="NAME">selection</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">command</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">ORYX.Plugins.Edit.DeleteCommand</span><span class="PUNC">(</span><span class="NAME">clipboard</span><span class="WHIT"> </span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.facade</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                                       </span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.executeCommands</span><span class="PUNC">(</span><span class="PUNC">[</span><span class="NAME">command</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="WHIT"></span><span class="NAME">ORYX.Plugins.Edit.ClipBoard</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Clazz.extend</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">construct</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.shapesAsJson</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.selection</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.SSnamespace</span><span class="PUNC">=</span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.useOffset</span><span class="PUNC">=</span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">isOccupied</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.shapesAsJson.length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">refresh</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">selection</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">shapes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">namespace</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">useNoOffset</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.selection</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">selection</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.SSnamespace</span><span class="PUNC">=</span><span class="NAME">namespace</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">// Store outgoings, targets and parents to restore them later on</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.outgoings</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.parents</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.targets</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.useOffset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">useNoOffset</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.shapesAsJson</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shapes.map</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.toJSON</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">s.parent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">resourceId</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">shape.getParentShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">resourceId</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">s.parentIndex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.getParentShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getChildShapes</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">indexOf</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="NAME">ORYX.Plugins.Edit.DeleteCommand</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Command.extend</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">construct</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">clipboard</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">facade</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.clipboard</span><span class="WHIT">          </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">clipboard</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.shapesAsJson</span><span class="WHIT">       </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">clipboard.shapesAsJson</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.facade</span><span class="WHIT">             </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">facade</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">// Store dockers of deleted shapes to restore connections</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.dockers</span><span class="WHIT">            </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.shapesAsJson.map</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shapeAsJson</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">shape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shapeAsJson.getShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">incomingDockers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.getIncomingShapes</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">map</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">s</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">s.getDockers</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">outgoingDockers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.getOutgoingShapes</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">map</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">s</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">s.getDockers</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">dockers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.getDockers</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">concat</span><span class="PUNC">(</span><span class="NAME">incomingDockers</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">outgoingDockers</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">compact</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">map</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">docker</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">object</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">referencePoint</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.referencePoint</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">dockedShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">docker.getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">dockers</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">flatten</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">          </span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">execute</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.shapesAsJson.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shapeAsJson</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">// Delete shape</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">this.facade.deleteShape</span><span class="PUNC">(</span><span class="NAME">shapeAsJson.getShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.facade.setSelection</span><span class="PUNC">(</span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">update</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.updateSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">rollback</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.shapesAsJson.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shapeAsJson</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">shape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shapeAsJson.getShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getChildShapeByResourceId</span><span class="PUNC">(</span><span class="NAME">shapeAsJson.parent.resourceId</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">parent.add</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">shape.parentIndex</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">//reconnect shapes</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.dockers.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">d</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">d.object.setDockedShape</span><span class="PUNC">(</span><span class="NAME">d.dockedShape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">d.object.setReferencePoint</span><span class="PUNC">(</span><span class="NAME">d.referencePoint</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.facade.setSelection</span><span class="PUNC">(</span><span class="NAME">this.selectedShapes</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">update</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.updateSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span></pre></body></html>