<html><head><meta http-equiv="content-type" content="text/html; charset=UTF-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="COMM">/** * Copyright (c) 2009 * Jan-Felix Schwarz, Willi Tscheschner, Nicolas Peters, Martin Czuchra, Daniel Polak * * Permission is hereby granted, free of charge, to any person obtaining a * copy of this software and associated documentation files (the "Software"), * to deal in the Software without restriction, including without limitation * the rights to use, copy, modify, merge, publish, distribute, sublicense, * and/or sell copies of the Software, and to permit persons to whom the * Software is furnished to do so, subject to the following conditions: * * The above copyright notice and this permission notice shall be included in * all copies or substantial portions of the Software. * * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER * DEALINGS IN THE SOFTWARE. **/</span><span class="WHIT"></span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">ORYX.Plugins</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">ORYX.Plugins</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Object</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="NAME">ORYX.Plugins.ShapeMenuPlugin</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">construct</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">facade</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">facade</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.alignGroups</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Hash</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">containerNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getHTMLContainer</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.shapeMenu</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">ORYX.Plugins.ShapeMenu</span><span class="PUNC">(</span><span class="NAME">containerNode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.currentShapes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Register on dragging and resizing events for show/hide of ShapeMenu</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.registerOnEvent</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_DRAGDROP_START</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.hideShapeMenu.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.registerOnEvent</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_DRAGDROP_END</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="NAME">this.showShapeMenu.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.registerOnEvent</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_RESIZE_START</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.hideShapeMenu</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.hideMorphMenu</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.registerOnEvent</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_RESIZE_END</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="NAME">this.showShapeMenu.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Enable DragZone</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">DragZone</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Ext.dd.DragZone</span><span class="PUNC">(</span><span class="NAME">containerNode.parentNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">shadow</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">Ext.isMac</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">DragZone.afterDragDrop</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.afterDragging.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">DragZone</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">DragZone.beforeDragOver</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.beforeDragOver.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">DragZone</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Memory of created Buttons</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.createdButtons</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.registerOnEvent</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_STENCIL_SET_LOADED</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">this.registryChanged</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.timer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.resetElements</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">hideShapeMenu</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">window.clearTimeout</span><span class="PUNC">(</span><span class="NAME">this.timer</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.timer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.shapeMenu.hide</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">showShapeMenu</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">dontGenerateNew</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">dontGenerateNew</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.resetElements</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">window.clearTimeout</span><span class="PUNC">(</span><span class="NAME">this.timer</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.timer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">window.setTimeout</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">// Close all Buttons</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.shapeMenu.closeAllButtons</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Show the Morph Button</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.showMorphButton</span><span class="PUNC">(</span><span class="NAME">this.currentShapes</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Show the Stencil Buttons</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.showStencilButtons</span><span class="PUNC">(</span><span class="NAME">this.currentShapes</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Show the ShapeMenu</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.shapeMenu.show</span><span class="PUNC">(</span><span class="NAME">this.currentShapes</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.resetElements</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">300</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">window.clearTimeout</span><span class="PUNC">(</span><span class="NAME">this.timer</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.timer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// Show the ShapeMenu</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.shapeMenu.show</span><span class="PUNC">(</span><span class="NAME">this.currentShapes</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">registryChanged</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">pluginsData</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">pluginsData</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">pluginsData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">pluginsData.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">value.group</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value.group</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">value.group</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">'unknown'</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.pluginsData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">pluginsData.sortBy</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">value.group</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">""</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">value.index</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.shapeMenu.removeAllButtons</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.shapeMenu.setNumberOfButtonsPerLevel</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.SHAPEMENU_RIGHT</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.createdButtons</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.createMorphMenu</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">this.pluginsData</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.pluginsData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.baseMorphStencils</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">baseMorphs</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Checks if the stencil set has morphing attributes</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isMorphing</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">containsMorphingRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Create Buttons for all Stencils of all loaded stencilsets</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">stencilsets</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getStencilSets</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">stencilsets.values</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">each</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">stencilSet</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">stencilSet.nodes</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">nodes.each</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">stencil</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">								</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Create a button for each node</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">option</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">stencil.id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">namespace</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">stencil.namespace</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">connectingType</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">button</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">ORYX.Plugins.ShapeMenuButton</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">callback</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="NAME">this.newShape.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">option</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">icon</span><span class="PUNC">:</span><span class="WHIT"> 		</span><span class="NAME">stencil.icon</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">align</span><span class="PUNC">:</span><span class="WHIT"> 		</span><span class="NAME">ORYX.CONFIG.SHAPEMENU_RIGHT</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">group</span><span class="PUNC">:</span><span class="WHIT">		</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">//dragcallback: this.hideShapeMenu.bind(this),</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">msg</span><span class="PUNC">:</span><span class="WHIT">		</span><span class="NAME">stencil.title</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">" - "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.ShapeMenuPlugin.clickDrag</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Add button to shape menu</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.shapeMenu.addButton</span><span class="PUNC">(</span><span class="NAME">button</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Add to the created Button Array</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.createdButtons</span><span class="PUNC">[</span><span class="NAME">stencil.namespace</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">stencil.type</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">stencil.id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">button</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Drag'n'Drop will enable</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">Ext.dd.Registry.register</span><span class="PUNC">(</span><span class="NAME">button.node.lastChild</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">option</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">edges</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">stencilSet.edges</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">edges.each</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">stencil</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Create a button for each edge</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">option</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">stencil.id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">namespace</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">stencil.namespace</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">button</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">ORYX.Plugins.ShapeMenuButton</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">callback</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="NAME">this.newShape.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">option</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">// icon: 		isMorphing ? ORYX.PATH + "images/edges.png" : stencil.icon(),</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">icon</span><span class="PUNC">:</span><span class="WHIT"> 		</span><span class="NAME">stencil.icon</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">align</span><span class="PUNC">:</span><span class="WHIT"> 		</span><span class="NAME">ORYX.CONFIG.SHAPEMENU_RIGHT</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">group</span><span class="PUNC">:</span><span class="WHIT">		</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">//dragcallback: this.hideShapeMenu.bind(this),</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">msg</span><span class="PUNC">:</span><span class="WHIT">		</span><span class="PUNC">(</span><span class="NAME">isMorphing</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.Edge</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">stencil.title</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">" - "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.I18N.ShapeMenuPlugin.drag</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Add button to shape menu</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.shapeMenu.addButton</span><span class="PUNC">(</span><span class="NAME">button</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Add to the created Button Array</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.createdButtons</span><span class="PUNC">[</span><span class="NAME">stencil.namespace</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">stencil.type</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">stencil.id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">button</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Drag'n'Drop will enable</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">Ext.dd.Registry.register</span><span class="PUNC">(</span><span class="NAME">button.node.lastChild</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">option</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">createMorphMenu</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.morphMenu</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Ext.menu.Menu</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">id</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">'Oryx_morph_menu'</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">items</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.morphMenu.on</span><span class="PUNC">(</span><span class="STRN">"mouseover"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.morphMenuHovered</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.morphMenu.on</span><span class="PUNC">(</span><span class="STRN">"mouseout"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.morphMenuHovered</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Create the button to show the morph menu</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">button</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">ORYX.Plugins.ShapeMenuButton</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">hovercallback</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">this.showMorphMenu.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">resetcallback</span><span class="PUNC">:</span><span class="WHIT"> 	</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">this.hideMorphMenu.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">callback</span><span class="PUNC">:</span><span class="WHIT">		</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.toggleMorphMenu.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">icon</span><span class="PUNC">:</span><span class="WHIT"> 			</span><span class="NAME">ORYX.PATH</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'images/wrench_orange.png'</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">align</span><span class="PUNC">:</span><span class="WHIT"> 			</span><span class="NAME">ORYX.CONFIG.SHAPEMENU_BOTTOM</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">group</span><span class="PUNC">:</span><span class="WHIT">			</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">msg</span><span class="PUNC">:</span><span class="WHIT">			</span><span class="NAME">ORYX.I18N.ShapeMenuPlugin.morphMsg</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.shapeMenu.setNumberOfButtonsPerLevel</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.SHAPEMENU_BOTTOM</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.shapeMenu.addButton</span><span class="PUNC">(</span><span class="NAME">button</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.morphMenu.getEl</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">appendTo</span><span class="PUNC">(</span><span class="NAME">button.node</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.morphButton</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">button</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">showMorphMenu</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.morphMenu.show</span><span class="PUNC">(</span><span class="NAME">this.morphButton.node</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this._morphMenuShown</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">hideMorphMenu</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.morphMenu.hide</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this._morphMenuShown</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">toggleMorphMenu</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this._morphMenuShown</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.hideMorphMenu</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.showMorphMenu</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">onSelectionChanged</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">event</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">elements</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">event.elements</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.hideShapeMenu</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.hideMorphMenu</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">this.currentShapes.inspect</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">elements.inspect</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.currentShapes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">elements</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.resetElements</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.showShapeMenu</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.showShapeMenu</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * Show button for morphing the selected shape into another stencil	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">showMorphButton</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">elements</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">elements.length</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">possibleMorphs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">morphStencils</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">stencil</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">elements</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getStencil</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">possibleMorphs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">possibleMorphs.select</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">morph</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">elements</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getStencil</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">type</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"node"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">//check containment rules</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">canContain</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">containingShape</span><span class="PUNC">:</span><span class="NAME">elements</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">parent</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">containedStencil</span><span class="PUNC">:</span><span class="NAME">morph</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">//check connect rules</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">canConnect</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">											</span><span class="NAME">sourceShape</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">elements</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">											</span><span class="NAME">edgeStencil</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">morph</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">											</span><span class="NAME">targetShape</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">elements</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">											</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">possibleMorphs.size</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">&lt;=</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// if morphing to other stencils is not possible, don't show button</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.morphMenu.removeAll</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// populate morph menu with the possible morph stencils ordered by their position</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">possibleMorphs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">possibleMorphs.sortBy</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">stencil</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">stencil.position</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">possibleMorphs.each</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">morph</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">menuItem</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Ext.menu.Item</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">text</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">morph.title</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">icon</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">morph.icon</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">disabled</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">morph.id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">==</span><span class="NAME">elements</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getStencil</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">disabledClass</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.MORPHITEM_DISABLED</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">handler</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">this.morphShape</span><span class="PUNC">(</span><span class="NAME">elements</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">morph</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.morphMenu.add</span><span class="PUNC">(</span><span class="NAME">menuItem</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.morphButton.prepareToShow</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * Show buttons for creating following shapes	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">showStencilButtons</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">elements</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">elements.length</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">//TODO temporaere nutzung des stencilsets</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getStencilSets</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NAME">elements</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getStencil</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">namespace</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Get all available edges</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">edges</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">outgoingEdgeStencils</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">canvas</span><span class="PUNC">:</span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sourceShape</span><span class="PUNC">:</span><span class="NAME">elements</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// And find all targets for each Edge</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">targets</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">addedEdges</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isMorphing</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">containsMorphingRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">edges.each</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">edge</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isMorphing</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.baseMorphStencils.include</span><span class="PUNC">(</span><span class="NAME">edge</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">shallAppear</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">// if edge is member of a morph groups where none of the base morphs is in the outgoing edges</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">// we want to display the button (but only for the first one)</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">possibleMorphs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">morphStencils</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">stencil</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">edge</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">shallAppear</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">possibleMorphs.any</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">morphStencil</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.baseMorphStencils.include</span><span class="PUNC">(</span><span class="NAME">morphStencil</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">edges.include</span><span class="PUNC">(</span><span class="NAME">morphStencil</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">addedEdges.include</span><span class="PUNC">(</span><span class="NAME">morphStencil</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">shallAppear</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">isMorphing</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.createdButtons</span><span class="PUNC">[</span><span class="NAME">edge.namespace</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">edge.type</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">edge.id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.createdButtons</span><span class="PUNC">[</span><span class="NAME">edge.namespace</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">edge.type</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">edge.id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">prepareToShow</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">addedEdges.push</span><span class="PUNC">(</span><span class="NAME">edge</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// get all targets for this edge</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">targets</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">targets.concat</span><span class="PUNC">(</span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">targetStencils</span><span class="PUNC">(</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">{</span><span class="NAME">canvas</span><span class="PUNC">:</span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sourceShape</span><span class="PUNC">:</span><span class="NAME">elements</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">edgeStencil</span><span class="PUNC">:</span><span class="NAME">edge</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">targets.uniq</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">addedTargets</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Iterate all possible target </span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">targets.each</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">target</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isMorphing</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// continue with next target stencil</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">target.type</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">===</span><span class="STRN">"edge"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// continue when stencil should not shown in the shape menu</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">showInShapeMenu</span><span class="PUNC">(</span><span class="NAME">target</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// if target is not a base morph </span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.baseMorphStencils.include</span><span class="PUNC">(</span><span class="NAME">target</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">// if target is member of a morph groups where none of the base morphs is in the targets</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">// we want to display the button (but only for the first one)</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">possibleMorphs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">morphStencils</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">stencil</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">target</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">possibleMorphs.size</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">==</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// continue with next target</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">baseMorphInTargets</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">possibleMorphs.any</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">morphStencil</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.baseMorphStencils.include</span><span class="PUNC">(</span><span class="NAME">morphStencil</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">targets.include</span><span class="PUNC">(</span><span class="NAME">morphStencil</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">addedTargets.include</span><span class="PUNC">(</span><span class="NAME">morphStencil</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">baseMorphInTargets</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// continue with next target</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// if this is reached the button shall appear in the shape menu:</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.createdButtons</span><span class="PUNC">[</span><span class="NAME">target.namespace</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">target.type</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">target.id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.createdButtons</span><span class="PUNC">[</span><span class="NAME">target.namespace</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">target.type</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">target.id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">prepareToShow</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">addedTargets.push</span><span class="PUNC">(</span><span class="NAME">target</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">beforeDragOver</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">dragZone</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">target</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">event</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.shapeMenu.isVisible</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.hideShapeMenu</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">coord</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.eventCoordinates</span><span class="PUNC">(</span><span class="NAME">event.browserEvent</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">aShapes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getAbstractShapesAtPosition</span><span class="PUNC">(</span><span class="NAME">coord</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">aShapes.length</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">el</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">aShapes.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this._lastOverElement</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">el</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// check containment rules</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">option</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Ext.dd.Registry.getHandle</span><span class="PUNC">(</span><span class="NAME">target.DDM.currentTarget</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// revert to original options if these were modified</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">option.backupOptions</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">key</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">option.backupOptions</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">option</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">option.backupOptions</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">option.backupOptions</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">stencilSet</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getStencilSets</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NAME">option.namespace</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">stencil</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">stencilSet.stencil</span><span class="PUNC">(</span><span class="NAME">option.type</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">candidate</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">aShapes.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">stencil.type</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"node"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">//check containment rules</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">canContain</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">canContain</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">containingShape</span><span class="PUNC">:</span><span class="NAME">candidate</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">containedStencil</span><span class="PUNC">:</span><span class="NAME">stencil</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">									</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// if not canContain, try to find a morph which can be contained</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">canContain</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">possibleMorphs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">morphStencils</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">stencil</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">stencil</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">&lt;</span><span class="NAME">possibleMorphs.size</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">canContain</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">canContain</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">containingShape</span><span class="PUNC">:</span><span class="NAME">candidate</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">containedStencil</span><span class="PUNC">:</span><span class="NAME">possibleMorphs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">canContain</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">option.backupOptions</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Object.clone</span><span class="PUNC">(</span><span class="NAME">option</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">option.type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">possibleMorphs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">option.namespace</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">possibleMorphs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">namespace</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this._currentReference</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">canContain</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">candidate</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="COMM">//Edge</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">curCan</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">candidate</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">orgCan</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">candidate</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">canConnect</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">while</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">canConnect</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">curCan</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">curCan</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Canvas</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">candidate</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">curCan</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">//check connection rules</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">canConnect</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">canConnect</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">											</span><span class="NAME">sourceShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.currentShapes.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">											</span><span class="NAME">edgeStencil</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">stencil</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">											</span><span class="NAME">targetShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">curCan</span><span class="WHIT"></span><span class="WHIT">											</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">curCan</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">curCan.parent</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			 	</span><span class="COMM">// if not canConnect, try to find a morph which can be connected</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">canConnect</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">candidate</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">orgCan</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">possibleMorphs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">morphStencils</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">stencil</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">stencil</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">&lt;</span><span class="NAME">possibleMorphs.size</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">curCan</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">candidate</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">canConnect</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">while</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">canConnect</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">curCan</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">curCan</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Canvas</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">candidate</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">curCan</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="COMM">//check connection rules</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">canConnect</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">canConnect</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">														</span><span class="NAME">sourceShape</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">this.currentShapes.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">														</span><span class="NAME">edgeStencil</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">possibleMorphs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">														</span><span class="NAME">targetShape</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">curCan</span><span class="WHIT"></span><span class="WHIT">													</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">curCan</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">curCan.parent</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">canConnect</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">option.backupOptions</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Object.clone</span><span class="PUNC">(</span><span class="NAME">option</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">option.type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">possibleMorphs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">option.namespace</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">possibleMorphs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">namespace</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">							</span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">candidate</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">orgCan</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">										</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this._currentReference</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">canConnect</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">candidate</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.facade.raiseEvent</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">											</span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT">		</span><span class="NAME">ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">											</span><span class="NAME">highlightId</span><span class="PUNC">:</span><span class="STRN">'shapeMenu'</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">											</span><span class="NAME">elements</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="PUNC">[</span><span class="NAME">candidate</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">											</span><span class="NAME">color</span><span class="PUNC">:</span><span class="WHIT">		</span><span class="NAME">this._currentReference</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SELECTION_VALID_COLOR</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SELECTION_INVALID_COLOR</span><span class="WHIT"></span><span class="WHIT">										</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">												</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pr</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dragZone.getProxy</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">pr.setStatus</span><span class="PUNC">(</span><span class="NAME">this._currentReference</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">pr.dropAllowed</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">pr.dropNotAllowed</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">pr.sync</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">										</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this._lastOverElement</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">afterDragging</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">dragZone</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">target</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">event</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">this.currentShapes</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">)</span><span class="PUNC">||</span><span class="NAME">this.currentShapes.length</span><span class="PUNC">&lt;=</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sourceShape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.currentShapes</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this._lastOverElement</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Hide the highlighting</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.raiseEvent</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">highlightId</span><span class="PUNC">:</span><span class="STRN">'shapeMenu'</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Check if drop is allowed</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">proxy</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dragZone.getProxy</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">proxy.dropStatus</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">proxy.dropNotAllowed</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.facade.updateSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Check if there is a current Parent</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this._currentReference</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">option</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Ext.dd.Registry.getHandle</span><span class="PUNC">(</span><span class="NAME">target.DDM.currentTarget</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">option</span><span class="PUNC">[</span><span class="STRN">'parent'</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._currentReference</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xy</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">event.getXY</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pos</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">x</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">xy</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">y</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">xy</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">a</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">node.getScreenCTM</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Correcting the UpperLeft-Offset</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">pos.x</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">a.e</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">pos.y</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">a.f</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Correcting the Zoom-Faktor</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">pos.x</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">a.a</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">pos.y</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">a.d</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Correcting the ScrollOffset</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">pos.x</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.documentElement.scrollLeft</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">pos.y</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.documentElement.scrollTop</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parentAbs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._currentReference.absoluteXY</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">pos.x</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentAbs.x</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">pos.y</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentAbs.y</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// If the ctrl key is not pressed, </span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// snapp the new shape to the center </span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// if it is near to the center of the other shape</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">event.ctrlKey</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// Get the center of the shape</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cShape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.currentShapes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">bounds.center</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// Snapp +-20 Pixel horizontal to the center </span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NUMB">20</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">cShape.x</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">pos.x</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">pos.x</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cShape.x</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// Snapp +-20 Pixel vertical to the center </span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NUMB">20</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">cShape.y</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">pos.y</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">pos.y</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cShape.y</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">option</span><span class="PUNC">[</span><span class="STRN">'position'</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">pos</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">option</span><span class="PUNC">[</span><span class="STRN">'connectedShape'</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.currentShapes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">option</span><span class="PUNC">[</span><span class="STRN">'connectingType'</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">stencilset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getStencilSets</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NAME">option.namespace</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">containedStencil</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">stencilset.stencil</span><span class="PUNC">(</span><span class="NAME">option.type</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">args</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">sourceShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.currentShapes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">targetStencil</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">containedStencil</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">option</span><span class="PUNC">[</span><span class="STRN">'connectingType'</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">connectMorph</span><span class="PUNC">(</span><span class="NAME">args</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.SHAPEMENU_DISABLE_CONNECTED_EDGE</span><span class="PUNC">===</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">option</span><span class="PUNC">[</span><span class="STRN">'connectingType'</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">command</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">ORYX.Plugins.ShapeMenuPlugin.CreateCommand</span><span class="PUNC">(</span><span class="NAME">Object.clone</span><span class="PUNC">(</span><span class="NAME">option</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this._currentReference</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pos</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.executeCommands</span><span class="PUNC">(</span><span class="PUNC">[</span><span class="NAME">command</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Inform about completed Drag </span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.raiseEvent</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.EVENT_SHAPE_MENU_CLOSE</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">source</span><span class="PUNC">:</span><span class="NAME">sourceShape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">destination</span><span class="PUNC">:</span><span class="NAME">this.currentShapes</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// revert to original options if these were modified</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">option.backupOptions</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">key</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">option.backupOptions</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">option</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">option.backupOptions</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">option.backupOptions</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this._currentReference</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">newShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">option</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">event</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">stencilset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getStencilSets</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NAME">option.namespace</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">containedStencil</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">stencilset.stencil</span><span class="PUNC">(</span><span class="NAME">option.type</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">canContain</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">containingShape</span><span class="PUNC">:</span><span class="NAME">this.currentShapes.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">parent</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="STRN">"containedStencil"</span><span class="PUNC">:</span><span class="NAME">containedStencil</span><span class="WHIT">
<span class='line'>  2</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">option</span><span class="PUNC">[</span><span class="STRN">'connectedShape'</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.currentShapes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">option</span><span class="PUNC">[</span><span class="STRN">'parent'</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.currentShapes.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">parent</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">option</span><span class="PUNC">[</span><span class="STRN">'containedStencil'</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">containedStencil</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">args</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">sourceShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.currentShapes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">targetStencil</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">containedStencil</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">targetStencil</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">connectMorph</span><span class="PUNC">(</span><span class="NAME">args</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">targetStencil</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="COMM">// Check if there can be a target shape</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">option</span><span class="PUNC">[</span><span class="STRN">'connectingType'</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">targetStencil.id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.SHAPEMENU_DISABLE_CONNECTED_EDGE</span><span class="PUNC">===</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">option</span><span class="PUNC">[</span><span class="STRN">'connectingType'</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">command</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">ORYX.Plugins.ShapeMenuPlugin.CreateCommand</span><span class="PUNC">(</span><span class="NAME">option</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.facade.executeCommands</span><span class="PUNC">(</span><span class="PUNC">[</span><span class="NAME">command</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * Morph a shape to a new stencil	 * {Command implemented}	 * @param {Shape} shape	 * @param {Stencil} stencil	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">morphShape</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">stencil</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">MorphTo</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Command.extend</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">construct</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">stencil</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">facade</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.shape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.stencil</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">stencil</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.facade</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">facade</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">execute</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">shape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.shape</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">stencil</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.stencil</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">resourceId</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.resourceId</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Serialize all attributes</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">serialized</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.serialize</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">stencil.properties</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">each</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">prop</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">prop.readonly</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">serialized</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">serialized.reject</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">serProp</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">serProp.name</span><span class="PUNC">==</span><span class="NAME">prop.id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Get shape if already created, otherwise create a new shape</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.newShape</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">newShape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.newShape</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">add</span><span class="PUNC">(</span><span class="NAME">newShape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">newShape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.facade.createShape</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">									</span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">stencil.id</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">									</span><span class="NAME">namespace</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">stencil.namespace</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">									</span><span class="NAME">resourceId</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">resourceId</span><span class="WHIT"></span><span class="WHIT">								</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// calculate new bounds using old shape's upperLeft and new shape's width/height</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">boundsObj</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">serialized.find</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">serProp</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">serProp.prefix</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"oryx"</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">serProp.name</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"bounds"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">changedBounds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.facade.getRules</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">preserveBounds</span><span class="PUNC">(</span><span class="NAME">shape.getStencil</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">bounds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">boundsObj.value.split</span><span class="PUNC">(</span><span class="STRN">","</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">bounds</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">bounds</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="COMM">// if lowerRight comes first, swap array items</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">tmp</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bounds</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">bounds</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bounds</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">bounds</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">tmp</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">tmp</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bounds</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">bounds</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bounds</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">bounds</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">tmp</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">bounds</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">bounds</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">newShape.bounds.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">bounds</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">bounds</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">newShape.bounds.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">boundsObj.value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bounds.join</span><span class="PUNC">(</span><span class="STRN">","</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">  </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">height</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.bounds.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">width</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.bounds.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">// consider the minimum and maximum size of</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">// the new shape</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">newShape.minimumSize</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">shape.bounds.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">newShape.minimumSize.height</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">height</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newShape.minimumSize.height</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">						</span><span class="WHIT"></span><span class="WHIT">						</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">shape.bounds.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">newShape.minimumSize.width</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">width</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newShape.minimumSize.width</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">newShape.maximumSize</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">shape.bounds.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">newShape.maximumSize.height</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">height</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newShape.maximumSize.height</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">						</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">shape.bounds.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">newShape.maximumSize.width</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">width</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newShape.maximumSize.width</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">changedBounds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">a</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">x</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">shape.bounds.a.x</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">y</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">shape.bounds.a.y</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">b</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">x</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">shape.bounds.a.x</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">width</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">y</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">shape.bounds.a.y</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">height</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">						</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">oPos</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.bounds.center</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">changedBounds</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">newShape.bounds.set</span><span class="PUNC">(</span><span class="NAME">changedBounds</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Set all related dockers</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.setRelatedDockers</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newShape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// store DOM position of old shape</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parentNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.node.parentNode</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nextSibling</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.node.nextSibling</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Delete the old shape</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.facade.deleteShape</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Deserialize the new shape - Set all attributes</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">newShape.deserialize</span><span class="PUNC">(</span><span class="NAME">serialized</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">/*				 * Change color to default if unchanged				 * 23.04.2010				 */</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">shape.getStencil</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">property</span><span class="PUNC">(</span><span class="STRN">"oryx-bgcolor"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">shape.properties</span><span class="PUNC">[</span><span class="STRN">"oryx-bgcolor"</span><span class="PUNC">]</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">shape.getStencil</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">property</span><span class="PUNC">(</span><span class="STRN">"oryx-bgcolor"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toUpperCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">shape.properties</span><span class="PUNC">[</span><span class="STRN">"oryx-bgcolor"</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">toUpperCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">newShape.getStencil</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">property</span><span class="PUNC">(</span><span class="STRN">"oryx-bgcolor"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">newShape.setProperty</span><span class="PUNC">(</span><span class="STRN">"oryx-bgcolor"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newShape.getStencil</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">property</span><span class="PUNC">(</span><span class="STRN">"oryx-bgcolor"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">value</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">changedBounds</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">newShape.bounds.set</span><span class="PUNC">(</span><span class="NAME">changedBounds</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">newShape.getStencil</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">type</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">===</span><span class="STRN">"edge"</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">newShape.dockers.length</span><span class="PUNC">==</span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">newShape.dockers</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">newShape.bounds.centerMoveTo</span><span class="PUNC">(</span><span class="NAME">oPos</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">newShape.getStencil</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">type</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">===</span><span class="STRN">"node"</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">newShape.dockers.length</span><span class="PUNC">==</span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">newShape.dockers</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.setRelatedDockers</span><span class="PUNC">(</span><span class="NAME">newShape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newShape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// place at the DOM position of the old shape</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">nextSibling</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">parentNode.insertBefore</span><span class="PUNC">(</span><span class="NAME">newShape.node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nextSibling</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">parentNode.appendChild</span><span class="PUNC">(</span><span class="NAME">newShape.node</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Set selection</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.facade.setSelection</span><span class="PUNC">(</span><span class="PUNC">[</span><span class="NAME">newShape</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">update</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.facade.updateSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.newShape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newShape</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">rollback</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.shape</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">this.newShape</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">this.newShape.parent</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="KEYW">return</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Append shape to the parent</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.newShape.parent.add</span><span class="PUNC">(</span><span class="NAME">this.shape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Set dockers</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.setRelatedDockers</span><span class="PUNC">(</span><span class="NAME">this.newShape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.shape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Delete new shape</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.facade.deleteShape</span><span class="PUNC">(</span><span class="NAME">this.newShape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Set selection</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.facade.setSelection</span><span class="PUNC">(</span><span class="PUNC">[</span><span class="NAME">this.shape</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Update</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">update</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.facade.updateSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">/**			 * Set all incoming and outgoing edges from the shape to the new shape			 * @param {Shape} shape			 * @param {Shape} newShape			 */</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">setRelatedDockers</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newShape</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">shape.getStencil</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">type</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">===</span><span class="STRN">"node"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">(</span><span class="NAME">shape.incoming</span><span class="PUNC">||</span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">concat</span><span class="PUNC">(</span><span class="NAME">shape.outgoing</span><span class="PUNC">||</span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">.</span><span class="NAME">each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">							</span><span class="NAME">i.dockers.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">docker</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">								</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">docker.getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">shape</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">									</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rPoint</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Object.clone</span><span class="PUNC">(</span><span class="NAME">docker.referencePoint</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">									</span><span class="COMM">// Move reference point per percent</span><span class="WHIT"></span><span class="WHIT">									</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rPointNew</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">										</span><span class="NAME">x</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">rPoint.x</span><span class="PUNC">*</span><span class="NAME">newShape.bounds.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="NAME">shape.bounds.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">										</span><span class="NAME">y</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">rPoint.y</span><span class="PUNC">*</span><span class="NAME">newShape.bounds.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="NAME">shape.bounds.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">									</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">									</span><span class="NAME">docker.setDockedShape</span><span class="PUNC">(</span><span class="NAME">newShape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">									</span><span class="COMM">// Set reference point and center to new position</span><span class="WHIT"></span><span class="WHIT">									</span><span class="NAME">docker.setReferencePoint</span><span class="PUNC">(</span><span class="NAME">rPointNew</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">									</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Edge</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">										</span><span class="NAME">docker.bounds.centerMoveTo</span><span class="PUNC">(</span><span class="NAME">rPointNew</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">									</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">										</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">absXY</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shape.absoluteXY</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">										</span><span class="NAME">docker.bounds.centerMoveTo</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">x</span><span class="PUNC">:</span><span class="NAME">rPointNew.x</span><span class="PUNC">+</span><span class="NAME">absXY.x</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">y</span><span class="PUNC">:</span><span class="NAME">rPointNew.y</span><span class="PUNC">+</span><span class="NAME">absXY.y</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">										</span><span class="COMM">//docker.bounds.moveBy({x:rPointNew.x-rPoint.x, y:rPointNew.y-rPoint.y});</span><span class="WHIT"></span><span class="WHIT">									</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">								</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">							</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">						</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">// for attached events</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">shape.dockers.length</span><span class="PUNC">></span><span class="NUMB">0</span><span class="PUNC">&&</span><span class="NAME">shape.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">newShape.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setDockedShape</span><span class="PUNC">(</span><span class="NAME">shape.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">newShape.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setReferencePoint</span><span class="PUNC">(</span><span class="NAME">Object.clone</span><span class="PUNC">(</span><span class="NAME">shape.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">referencePoint</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="COMM">// is edge</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">newShape.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setDockedShape</span><span class="PUNC">(</span><span class="NAME">shape.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">newShape.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setReferencePoint</span><span class="PUNC">(</span><span class="NAME">shape.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">referencePoint</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">newShape.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setDockedShape</span><span class="PUNC">(</span><span class="NAME">shape.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getDockedShape</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">newShape.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setReferencePoint</span><span class="PUNC">(</span><span class="NAME">shape.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">referencePoint</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Create and execute command (for undo/redo)			</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">command</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">MorphTo</span><span class="PUNC">(</span><span class="NAME">shape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">stencil</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.facade</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.facade.executeCommands</span><span class="PUNC">(</span><span class="PUNC">[</span><span class="NAME">command</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="NAME">ORYX.Plugins.ShapeMenuPlugin</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ORYX.Plugins.AbstractPlugin.extend</span><span class="PUNC">(</span><span class="NAME">ORYX.Plugins.ShapeMenuPlugin</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="NAME">ORYX.Plugins.ShapeMenu</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/***	 * Constructor.	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">construct</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">parentNode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.bounds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.shapes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.buttons</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.isVisible</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ORYX.Editor.graft</span><span class="PUNC">(</span><span class="STRN">"http://www.w3.org/1999/xhtml"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">$</span><span class="PUNC">(</span><span class="NAME">parentNode</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">[</span><span class="STRN">'div'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">id</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.Editor.provideId</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'class'</span><span class="PUNC">:</span><span class="STRN">'Oryx_ShapeMenu'</span><span class="PUNC">}</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.alignContainers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Hash</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.numberOfButtonsPerLevel</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Hash</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">addButton</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">button</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.buttons.push</span><span class="PUNC">(</span><span class="NAME">button</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// lazy grafting of the align containers</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.alignContainers</span><span class="PUNC">[</span><span class="NAME">button.align</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.alignContainers</span><span class="PUNC">[</span><span class="NAME">button.align</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ORYX.Editor.graft</span><span class="PUNC">(</span><span class="STRN">"http://www.w3.org/1999/xhtml"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.node</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">[</span><span class="STRN">'div'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="STRN">'class'</span><span class="PUNC">:</span><span class="NAME">button.align</span><span class="PUNC">}</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.node.appendChild</span><span class="PUNC">(</span><span class="NAME">this.alignContainers</span><span class="PUNC">[</span><span class="NAME">button.align</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// add event listeners for hover effect</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">onBubble</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.alignContainers</span><span class="PUNC">[</span><span class="NAME">button.align</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">addEventListener</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_MOUSEOVER</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.hoverAlignContainer.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">button.align</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">onBubble</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.alignContainers</span><span class="PUNC">[</span><span class="NAME">button.align</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">addEventListener</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_MOUSEOUT</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.resetAlignContainer.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">button.align</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">onBubble</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.alignContainers</span><span class="PUNC">[</span><span class="NAME">button.align</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">addEventListener</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_MOUSEUP</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.hoverAlignContainer.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">button.align</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">onBubble</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.alignContainers</span><span class="PUNC">[</span><span class="NAME">button.align</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">appendChild</span><span class="PUNC">(</span><span class="NAME">button.node</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">deleteButton</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">button</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.buttons</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.buttons.without</span><span class="PUNC">(</span><span class="NAME">button</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.removeChild</span><span class="PUNC">(</span><span class="NAME">button.node</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">removeAllButtons</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">me</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.buttons.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">value.node</span><span class="PUNC">&&</span><span class="NAME">value.node.parentNode</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">value.node.parentNode.removeChild</span><span class="PUNC">(</span><span class="NAME">value.node</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.buttons</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">closeAllButtons</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.buttons.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">value.prepareToHide</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.isVisible</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * Show the shape menu	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">show</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">shapes</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">//shapes = (shapes||[]).findAll(function(r){ return r && r.node && r.node.parent });</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">shapes.length</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.shapes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">shapes</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newBounds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">tmpBounds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.shapes.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">a</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value.node.getScreenCTM</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">upL</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value.absoluteXY</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">a.e</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">a.a</span><span class="PUNC">*</span><span class="NAME">upL.x</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">a.f</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">a.d</span><span class="PUNC">*</span><span class="NAME">upL.y</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">tmpBounds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Bounds</span><span class="PUNC">(</span><span class="NAME">a.e</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">a.f</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">a.e</span><span class="PUNC">+</span><span class="NAME">a.a</span><span class="PUNC">*</span><span class="NAME">value.bounds.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">a.f</span><span class="PUNC">+</span><span class="NAME">a.d</span><span class="PUNC">*</span><span class="NAME">value.bounds.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">/*if(value instanceof ORYX.Core.Edge) {				tmpBounds.moveBy(value.bounds.upperLeft())			}*/</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">newBounds</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">newBounds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">tmpBounds</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">else</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">newBounds.include</span><span class="PUNC">(</span><span class="NAME">tmpBounds</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.bounds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newBounds</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">//this.bounds.moveBy({x:document.documentElement.scrollLeft, y:document.documentElement.scrollTop});</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">bounds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.bounds</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">a</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.bounds.upperLeft</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">left</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">leftButtonGroup</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">top</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">topButtonGroup</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">bottom</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">bottomButtonGroup</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">right</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">rightButtonGroup</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">22</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.getWillShowButtons</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">sortBy</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">button</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">button.group</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.getWillShowButtons</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">button</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">numOfButtonsPerLevel</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getNumberOfButtonsPerLevel</span><span class="PUNC">(</span><span class="NAME">button.align</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">button.align</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_LEFT</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// vertical levels</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">button.group</span><span class="PUNC">!=</span><span class="NAME">leftButtonGroup</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">left</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">leftButtonGroup</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">button.group</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">x</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.floor</span><span class="PUNC">(</span><span class="NAME">left</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NAME">numOfButtonsPerLevel</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">y</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">left</span><span class="WHIT"> </span><span class="PUNC">%</span><span class="WHIT"> </span><span class="NAME">numOfButtonsPerLevel</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">button.setLevel</span><span class="PUNC">(</span><span class="NAME">x</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">button.setPosition</span><span class="PUNC">(</span><span class="NAME">a.x</span><span class="PUNC">-</span><span class="NUMB">5</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">x</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">*</span><span class="NAME">size</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">a.y</span><span class="PUNC">+</span><span class="NAME">numOfButtonsPerLevel</span><span class="PUNC">*</span><span class="NAME">button.group</span><span class="PUNC">*</span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">button.group</span><span class="PUNC">*</span><span class="NUMB">0.3</span><span class="PUNC">*</span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">y</span><span class="PUNC">*</span><span class="NAME">size</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">//button.setPosition(a.x-22, a.y+left*size);</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">left</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT"> 			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">button.align</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_TOP</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="COMM">// horizontal levels</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">button.group</span><span class="PUNC">!=</span><span class="NAME">topButtonGroup</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">top</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">topButtonGroup</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">button.group</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">x</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">top</span><span class="WHIT"> </span><span class="PUNC">%</span><span class="WHIT"> </span><span class="NAME">numOfButtonsPerLevel</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">y</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.floor</span><span class="PUNC">(</span><span class="NAME">top</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NAME">numOfButtonsPerLevel</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="NAME">button.setLevel</span><span class="PUNC">(</span><span class="NAME">y</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="NAME">button.setPosition</span><span class="PUNC">(</span><span class="NAME">a.x</span><span class="PUNC">+</span><span class="NAME">numOfButtonsPerLevel</span><span class="PUNC">*</span><span class="NAME">button.group</span><span class="PUNC">*</span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">button.group</span><span class="PUNC">*</span><span class="NUMB">0.3</span><span class="PUNC">*</span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">x</span><span class="PUNC">*</span><span class="NAME">size</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT"> 						</span><span class="NAME">a.y</span><span class="PUNC">-</span><span class="NUMB">5</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">y</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">*</span><span class="NAME">size</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">top</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT"> 			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">button.align</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_BOTTOM</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="COMM">// horizontal levels</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">button.group</span><span class="PUNC">!=</span><span class="NAME">bottomButtonGroup</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">bottom</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">bottomButtonGroup</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">button.group</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">x</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bottom</span><span class="WHIT"> </span><span class="PUNC">%</span><span class="WHIT"> </span><span class="NAME">numOfButtonsPerLevel</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">y</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.floor</span><span class="PUNC">(</span><span class="NAME">bottom</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NAME">numOfButtonsPerLevel</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="NAME">button.setLevel</span><span class="PUNC">(</span><span class="NAME">y</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="WHIT"></span><span class="WHIT"> 				</span><span class="NAME">button.setPosition</span><span class="PUNC">(</span><span class="NAME">a.x</span><span class="PUNC">+</span><span class="NAME">numOfButtonsPerLevel</span><span class="PUNC">*</span><span class="NAME">button.group</span><span class="PUNC">*</span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">button.group</span><span class="PUNC">*</span><span class="NUMB">0.3</span><span class="PUNC">*</span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">x</span><span class="PUNC">*</span><span class="NAME">size</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT"> 						</span><span class="NAME">a.y</span><span class="PUNC">+</span><span class="NAME">bounds.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">5</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">y</span><span class="PUNC">*</span><span class="NAME">size</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">bottom</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// vertical levels</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">button.group</span><span class="PUNC">!=</span><span class="NAME">rightButtonGroup</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">right</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">rightButtonGroup</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">button.group</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">x</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.floor</span><span class="PUNC">(</span><span class="NAME">right</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NAME">numOfButtonsPerLevel</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">y</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">right</span><span class="WHIT"> </span><span class="PUNC">%</span><span class="WHIT"> </span><span class="NAME">numOfButtonsPerLevel</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">button.setLevel</span><span class="PUNC">(</span><span class="NAME">x</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">button.setPosition</span><span class="PUNC">(</span><span class="NAME">a.x</span><span class="PUNC">+</span><span class="NAME">bounds.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">5</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">x</span><span class="PUNC">*</span><span class="NAME">size</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">a.y</span><span class="PUNC">+</span><span class="NAME">numOfButtonsPerLevel</span><span class="PUNC">*</span><span class="NAME">button.group</span><span class="PUNC">*</span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">button.group</span><span class="PUNC">*</span><span class="NUMB">0.3</span><span class="PUNC">*</span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">y</span><span class="PUNC">*</span><span class="NAME">size</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">5</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">right</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">button.show</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.isVisible</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * Hide the shape menu	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">hide</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.buttons.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">button</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">button.hide</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.isVisible</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">//this.bounds = undefined;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">//this.shape = undefined;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">hoverAlignContainer</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">align</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">evt</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.buttons.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">button</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">button.align</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">align</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">button.showOpaque</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">resetAlignContainer</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">align</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">evt</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.buttons.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">button</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">button.align</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">align</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">button.showTransparent</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">isHover</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> 	</span><span class="NAME">this.buttons.any</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">value.isHover</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">getWillShowButtons</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.buttons.findAll</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">value.willShow</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * Returns a set on buttons for that align value	 * @params {String} align	 * @params {String} group	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">getButtons</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">align</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">group</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.getWillShowButtons</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">findAll</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">b</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">b.align</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">align</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">group</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">b.group</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">group</span><span class="PUNC">)</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * Set the number of buttons to display on each level of the shape menu in the specified align group.	 * Example: setNumberOfButtonsPerLevel(ORYX.CONFIG.SHAPEMENU_RIGHT, 2) causes that the buttons of the right align group 	 * will be rendered in 2 rows.	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">setNumberOfButtonsPerLevel</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">align</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">number</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.numberOfButtonsPerLevel</span><span class="PUNC">[</span><span class="NAME">align</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * Returns the number of buttons to display on each level of the shape menu in the specified align group.	 * Default value is 1	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">getNumberOfButtonsPerLevel</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">align</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.numberOfButtonsPerLevel</span><span class="PUNC">[</span><span class="NAME">align</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">Math.min</span><span class="PUNC">(</span><span class="NAME">this.getButtons</span><span class="PUNC">(</span><span class="NAME">align</span><span class="PUNC">,</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.numberOfButtonsPerLevel</span><span class="PUNC">[</span><span class="NAME">align</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="NAME">ORYX.Plugins.ShapeMenu</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Clazz.extend</span><span class="PUNC">(</span><span class="NAME">ORYX.Plugins.ShapeMenu</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="NAME">ORYX.Plugins.ShapeMenuButton</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="COMM">/**	 * Constructor	 * @param option A key map specifying the configuration options:	 * 					id: 	(String) The id of the parent DOM element for the new button	 * 					icon: 	(String) The url to the icon of the button	 * 					msg:	(String) A tooltip message	 * 					caption:(String) The caption of the button (attention: button width > 22, only set for single column button layouts)	 * 					align:	(String) The direction in which the button is aligned	 * 					group: 	(Integer) The button group in the specified alignment 	 * 							(buttons in the same group will be aligned side by side)	 * 					callback:		(Function) A callback that is executed when the button is clicked	 * 					dragcallback:	(Function) A callback that is executed when the button is dragged	 * 					hovercallback:	(Function) A callback that is executed when the button is hovered	 * 					resetcallback:	(Function) A callback that is executed when the button is reset	 * 					arguments:		(Array) An argument array to pass to the callback functions	 */</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">construct</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">option</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">option</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.option</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">option</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.option.arguments</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.option.arguments</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">//TODO error</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.parentId</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.option.id</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">this.option.id</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// graft the button.</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">buttonClassName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.option.caption</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">"Oryx_button_with_caption"</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">"Oryx_button"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ORYX.Editor.graft</span><span class="PUNC">(</span><span class="STRN">"http://www.w3.org/1999/xhtml"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">$</span><span class="PUNC">(</span><span class="NAME">this.parentId</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">[</span><span class="STRN">'div'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="STRN">'class'</span><span class="PUNC">:</span><span class="NAME">buttonClassName</span><span class="PUNC">}</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">imgOptions</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">src</span><span class="PUNC">:</span><span class="NAME">this.option.icon</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.option.msg</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">imgOptions.title</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.option.msg</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// graft and update icon (not in grafting for ns reasons).</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">//TODO Enrich graft()-function to do this in one of the above steps.</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.option.icon</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">ORYX.Editor.graft</span><span class="PUNC">(</span><span class="STRN">"http://www.w3.org/1999/xhtml"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.node</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">[</span><span class="STRN">'img'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">imgOptions</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.option.caption</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">captionNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ORYX.Editor.graft</span><span class="PUNC">(</span><span class="STRN">"http://www.w3.org/1999/xhtml"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="STRN">'span'</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">ORYX.Editor.graft</span><span class="PUNC">(</span><span class="STRN">"http://www.w3.org/1999/xhtml"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">captionNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.option.caption</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">onBubble</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.addEventListener</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_MOUSEOVER</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.hover.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">onBubble</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.addEventListener</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_MOUSEOUT</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.reset.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">onBubble</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.addEventListener</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_MOUSEDOWN</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.activate.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">onBubble</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.addEventListener</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_MOUSEUP</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.hover.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">onBubble</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.addEventListener</span><span class="PUNC">(</span><span class="STRN">'click'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.trigger.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">onBubble</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.addEventListener</span><span class="PUNC">(</span><span class="NAME">ORYX.CONFIG.EVENT_MOUSEMOVE</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.move.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">onBubble</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.align</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.option.align</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">this.option.align</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_RIGHT</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.group</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.option.group</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">this.option.group</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.hide</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.dragStart</span><span class="WHIT"> 	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.isVisible</span><span class="WHIT"> 	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.willShow</span><span class="WHIT"> 	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.resetTimer</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">hide</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.style.display</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"none"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.isVisible</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">show</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.style.display</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.style.opacity</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.opacity</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.isVisible</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">showOpaque</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.style.opacity</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1.0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">showTransparent</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.style.opacity</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.opacity</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">prepareToShow</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.willShow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">prepareToHide</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.willShow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.hide</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">setPosition</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">x</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">y</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.style.left</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">x</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"px"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.style.top</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">y</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"px"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">setLevel</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">level</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">level</span><span class="PUNC">==</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">this.opacity</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0.5</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">level</span><span class="PUNC">==</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">this.opacity</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0.2</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">//else if(level==2) this.opacity = 0.1;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">this.opacity</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0.0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">setChildWidth</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">width</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.childNode.style.width</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">width</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"px"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">reset</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Delete the timeout for hiding</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">window.clearTimeout</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">this.resetTimer</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.resetTimer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">window.setTimeout</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">this.doReset.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.option.resetcallback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.option.arguments.push</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">state</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.option.resetcallback.apply</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.option.arguments</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.option.arguments.remove</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">doReset</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.node.hasClassName</span><span class="PUNC">(</span><span class="STRN">'Oryx_down'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.node.removeClassName</span><span class="PUNC">(</span><span class="STRN">'Oryx_down'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.node.hasClassName</span><span class="PUNC">(</span><span class="STRN">'Oryx_hover'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.node.removeClassName</span><span class="PUNC">(</span><span class="STRN">'Oryx_hover'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">activate</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.addClassName</span><span class="PUNC">(</span><span class="STRN">'Oryx_down'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">//Event.stop(evt);</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.dragStart</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">isHover</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.node.hasClassName</span><span class="PUNC">(</span><span class="STRN">'Oryx_hover'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">hover</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">// Delete the timeout for hiding</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">window.clearTimeout</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">this.resetTimer</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.resetTimer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.node.addClassName</span><span class="PUNC">(</span><span class="STRN">'Oryx_hover'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.dragStart</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.option.hovercallback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.option.arguments.push</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">state</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.option.hovercallback.apply</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.option.arguments</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.option.arguments.remove</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">move</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.dragStart</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.option.dragcallback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.option.arguments.push</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">state</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.option.dragcallback.apply</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.option.arguments</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.option.arguments.remove</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">trigger</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.option.callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">//Event.stop(evt);</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.option.arguments.push</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">state</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.option.callback.apply</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.option.arguments</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.option.arguments.remove</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.dragStart</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">toString</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">"HTML-Button "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.id</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="NAME">ORYX.Plugins.ShapeMenuButton</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Clazz.extend</span><span class="PUNC">(</span><span class="NAME">ORYX.Plugins.ShapeMenuButton</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="COMM">//create command for undo/redo</span><span class="WHIT"></span><span class="NAME">ORYX.Plugins.ShapeMenuPlugin.CreateCommand</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Command.extend</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">construct</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">option</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">currentReference</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">position</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">plugin</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.option</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">option</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.currentReference</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentReference</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.position</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">position</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.plugin</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">plugin</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.shape</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.edge</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.targetRefPos</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.sourceRefPos</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">/*		 * clone options parameters		 */</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.connectedShape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">option.connectedShape</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.connectingType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">option.connectingType</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.namespace</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">option.namespace</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">option.type</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.containedStencil</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">option.containedStencil</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.parent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">option.parent</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.currentReference</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentReference</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">this.shapeOptions</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">option.shapeOptions</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">execute</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">resume</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.shape</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.shape</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Node</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.parent.add</span><span class="PUNC">(</span><span class="NAME">this.shape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.edge</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.plugin.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">add</span><span class="PUNC">(</span><span class="NAME">this.edge</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.edge.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setDockedShape</span><span class="PUNC">(</span><span class="NAME">this.connectedShape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.edge.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setReferencePoint</span><span class="PUNC">(</span><span class="NAME">this.sourceRefPos</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.edge.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setDockedShape</span><span class="PUNC">(</span><span class="NAME">this.shape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.edge.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setReferencePoint</span><span class="PUNC">(</span><span class="NAME">this.targetRefPos</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.plugin.facade.setSelection</span><span class="PUNC">(</span><span class="PUNC">[</span><span class="NAME">this.shape</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.shape</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Edge</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.plugin.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">add</span><span class="PUNC">(</span><span class="NAME">this.shape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.shape.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setDockedShape</span><span class="PUNC">(</span><span class="NAME">this.connectedShape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.shape.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setReferencePoint</span><span class="PUNC">(</span><span class="NAME">this.sourceRefPos</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">resume</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.shape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.plugin.facade.createShape</span><span class="PUNC">(</span><span class="NAME">this.option</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.edge</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">this.shape</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Edge</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">this.shape.getIncomingShapes</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.currentReference</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.position</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.shape</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Edge</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">this.currentReference</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Canvas</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.shape.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setDockedShape</span><span class="PUNC">(</span><span class="NAME">this.currentReference</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">// @deprecated It now uses simply the midpoint</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">upL</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.currentReference.absoluteXY</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">refPos</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">x</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.position.x</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">upL.x</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">						</span><span class="NAME">y</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.position.y</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">upL.y</span><span class="WHIT"></span><span class="WHIT">					</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.shape.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setReferencePoint</span><span class="PUNC">(</span><span class="NAME">this.currentReference.bounds.midPoint</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">this.shape.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">bounds.centerMoveTo</span><span class="PUNC">(</span><span class="NAME">this.position</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">					</span><span class="COMM">//this.shape.dockers.last().update();</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.sourceRefPos</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.shape.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">referencePoint</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.targetRefPos</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.shape.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">referencePoint</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.edge</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.sourceRefPos</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.edge.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">referencePoint</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.targetRefPos</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.edge.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">referencePoint</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">containedStencil</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.containedStencil</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">connectedShape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.connectedShape</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">bc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">connectedShape.bounds</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">bs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.shape.bounds</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pos</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bc.center</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">containedStencil.defaultAlign</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">===</span><span class="STRN">"north"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">pos.y</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bc.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bs.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">containedStencil.defaultAlign</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">===</span><span class="STRN">"northeast"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">pos.x</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bc.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bs.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">pos.y</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bc.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bs.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">containedStencil.defaultAlign</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">===</span><span class="STRN">"southeast"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">pos.x</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bc.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bs.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">pos.y</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bc.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bs.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">containedStencil.defaultAlign</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">===</span><span class="STRN">"south"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">pos.y</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bc.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bs.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">containedStencil.defaultAlign</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">===</span><span class="STRN">"southwest"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">pos.x</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bc.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bs.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">pos.y</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bc.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bs.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">containedStencil.defaultAlign</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">===</span><span class="STRN">"west"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">pos.x</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bc.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bs.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">containedStencil.defaultAlign</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">===</span><span class="STRN">"northwest"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">pos.x</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bc.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bs.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">pos.y</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bc.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bs.height</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">pos.x</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bc.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bs.width</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// Move shape to the new position</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.shape.bounds.centerMoveTo</span><span class="PUNC">(</span><span class="NAME">pos</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// Move all dockers of a node to the position</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.shape</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Node</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">(</span><span class="NAME">this.shape.dockers</span><span class="PUNC">||</span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">docker</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">					</span><span class="NAME">docker.bounds.centerMoveTo</span><span class="PUNC">(</span><span class="NAME">pos</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">//this.shape.update();</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.position</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">pos</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.edge</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.sourceRefPos</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.edge.dockers.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">referencePoint</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.targetRefPos</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.edge.dockers.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">referencePoint</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.plugin.facade.getCanvas</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">update</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.plugin.facade.updateSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">resume</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="COMM">// If there is a connected shape</span><span class="WHIT"></span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.edge</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Try to layout it</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.plugin.doLayout</span><span class="PUNC">(</span><span class="NAME">this.edge</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.shape</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">ORYX.Core.Edge</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">				</span><span class="COMM">// Try to layout it</span><span class="WHIT"></span><span class="WHIT">				</span><span class="NAME">this.plugin.doLayout</span><span class="PUNC">(</span><span class="NAME">this.shape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">rollback</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.plugin.facade.deleteShape</span><span class="PUNC">(</span><span class="NAME">this.shape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.edge</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">			</span><span class="NAME">this.plugin.facade.deleteShape</span><span class="PUNC">(</span><span class="NAME">this.edge</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">		</span><span class="COMM">//this.currentParent.update();</span><span class="WHIT"></span><span class="WHIT">		</span><span class="NAME">this.plugin.facade.setSelection</span><span class="PUNC">(</span><span class="NAME">this.plugin.facade.getSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">without</span><span class="PUNC">(</span><span class="NAME">this.shape</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.edge</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"></span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span></pre></body></html>